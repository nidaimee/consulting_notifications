<!-- app/views/clients/diet_pdf.html.erb -->
<div class="header">
  <h1>ğŸ“‹ PrescriÃ§Ã£o Nutricional</h1>
  <p>Plano Alimentar Personalizado</p>
</div>

<div class="client-info">
  <div class="client-details">
    <h2><%= @client.name %></h2>
    <div class="info-grid">
      <div class="info-item">
        <strong>ğŸ“ Telefone:</strong> <%= @client.phone_number %>
      </div>
      <div class="info-item">
        <strong>ğŸ“… PerÃ­odo:</strong> <%= @client.start_date.strftime('%d/%m/%Y') %> atÃ© <%= @client.end_date.strftime('%d/%m/%Y') %>
      </div>
      <div class="info-item">
        <strong>ğŸ“‹ Data da PrescriÃ§Ã£o:</strong> <%= Date.current.strftime('%d/%m/%Y') %>
      </div>
    </div>
    <% if @client.note.present? %>
      <div class="client-notes">
        <strong>ğŸ“ ObservaÃ§Ãµes:</strong> <%= @client.note %>
      </div>
    <% end %>
  </div>
</div>

<div class="instructions">
  <h3>ğŸ’¡ InstruÃ§Ãµes Importantes:</h3>
  <ul>
    <li>Siga as orientaÃ§Ãµes de horÃ¡rios sugeridos para cada refeiÃ§Ã£o</li>
    <li>As quantidades devem ser respeitadas conforme prescrito</li>
    <li>Beba pelo menos 2 litros de Ã¡gua por dia</li>
    <li>Em caso de dÃºvidas, entre em contato com seu nutricionista</li>
  </ul>
</div>

<% 
meal_types = [
  { key: 'breakfast', name: 'CafÃ© da ManhÃ£', time: '8:00', icon: 'ğŸŒ…' },
  { key: 'morning_snack', name: 'Lanche da ManhÃ£', time: '10:00', icon: 'ğŸ' },
  { key: 'lunch', name: 'AlmoÃ§o', time: '12:00', icon: 'ğŸ½ï¸' },
  { key: 'afternoon_snack', name: 'Lanche da Tarde', time: '15:00', icon: 'ğŸ¥¤' },
  { key: 'dinner', name: 'Jantar', time: '19:00', icon: 'ğŸŒ™' },
  { key: 'supper', name: 'Ceia', time: '22:00', icon: 'ğŸŒœ' }
]
%>

<div class="meals-container">
  <% 
    # Filtrar apenas refeiÃ§Ãµes que tÃªm alimentos
    filled_meals = meal_types.select do |meal_info|
      diet = @diets.find { |d| d.meal_type == meal_info[:key] }
      diet && diet.diet_foods.any?
    end
  %>
  
  <% if filled_meals.any? %>
    <% filled_meals.each_with_index do |meal_info, index| %>
      <% diet = @diets.find { |d| d.meal_type == meal_info[:key] } %>
      
      <div class="meal-section">
        <div class="meal-header">
          <div class="meal-title">
            <span class="meal-icon"><%= meal_info[:icon] %></span>
            <span class="meal-name"><%= meal_info[:name] %></span>
          </div>
          <div class="meal-time"><%= meal_info[:time] %></div>
        </div>
        
        <div class="meal-content">
          <div class="food-list">
            <% diet.diet_foods.includes(:food).each do |diet_food| %>
              <div class="food-item">
                <span class="quantity"><%= diet_food.quantity_grams.to_i %>g</span>
                <span class="food-name"><%= diet_food.food.name %></span>
              </div>
            <% end %>
          </div>
          
          <% if diet.notes.present? %>
            <div class="meal-notes">
              <strong>ğŸ’¡ ObservaÃ§Ã£o:</strong> <em><%= diet.notes %></em>
            </div>
          <% end %>
        </div>
      </div>
      
      <% # Page break apÃ³s 3 refeiÃ§Ãµes (se houver mais) %>
      <% if index == 2 && filled_meals.length > 3 %>
        <div class="page-break"></div>
      <% end %>
    <% end %>
  <% else %>
    <div class="no-meals">
      <div class="empty-state">
        <h3>ğŸ“ Plano Alimentar em ElaboraÃ§Ã£o</h3>
        <p>As refeiÃ§Ãµes especÃ­ficas estÃ£o sendo personalizadas para suas necessidades.</p>
        <p>Entre em contato com seu nutricionista para mais orientaÃ§Ãµes.</p>
      </div>
    </div>
  <% end %>
</div>

<%
# Coletar todos os alimentos Ãºnicos da dieta para determinar quais tabelas mostrar
all_foods = []
@diets.each do |diet|
  diet.diet_foods.includes(:food).each do |diet_food|
    all_foods << diet_food.food.name.downcase
  end
end
all_foods = all_foods.uniq

# Definir as tabelas de substituiÃ§Ã£o
substitution_tables = {
  vegetables_a: {
    title: "VEGETAIS A (LIVRES)",
    show_if: -> { all_foods.any? { |f| f.match?(/acelga|agriÃ£o|abobrinha|brÃ³colis|cebola|chicÃ³ria|espinafre|mostarda|palmito|repolho|rÃºcula|tomate|alface|aspargo|berinjela|cogumelo|couve|couve-flor|pepino|rabanete|pimentÃ£o/) } },
    items: [
      ["ACELGA", "ABOBRINHA", "BRÃ“COLIS", "ESPINAFRE", "REPOLHO", "ALFACE", "COGUMELOS", "PEPINO"],
      ["AGRIÃƒO", "", "CEBOLA", "MOSTARDA", "RÃšCULA", "ASPARGO", "COUVE", "RABANETE"],
      ["", "", "CHICÃ“RIA", "PALMITO", "TOMATE", "BERINJELA", "COUVE-FLOR", "PIMENTÃƒO"]
    ]
  },
  vegetables_b: {
    title: "VEGETAIS B",
    show_if: -> { all_foods.any? { |f| f.match?(/abÃ³bora|beterraba|cenoura|chuchu|nabo|quiabo|shimeji|shitake|vagem/) } },
    items: [
      ["ABÃ“BORA CABOTIÃ", "", "CHUCHU", "", "SHIMEJI", "", "", ""],
      ["BETERRABA", "", "NABO", "", "SHITAKE", "", "", ""],
      ["CENOURA", "", "QUIABO", "", "VAGEM", "", "", ""]
    ]
  },
  proteins_1: {
    title: "PROTEÃNAS 1",
    show_if: -> { all_foods.any? { |f| f.match?(/carne|frango|peixe|ovo|atum|sardinha|salmÃ£o|tilÃ¡pia|pescada|patinho|mÃºsculo|lagarto|filÃ© mignon|coxa|sobrecoxa/) } },
    items: [
      ["83g CARNE VERMELHA MAGRA SEM GORDURA (PATINHO, PALETA, MÃšSCULO, LAGARTO, FILÃ‰ MIGNON, COXÃƒO MOLE E COXÃƒO DURO)", "110g PEIXE ASSADO, GRELHADO OU COZIDO SEM Ã“LEO (ATUM, SARDINHA, BACALHAU, PESCADO, TILÃPIA E PESCADA)"],
      ["87g CARNE SUÃNA MAGRA SEM GORDURA (FILÃ‰ MIGNON SUÃNO E LOMBO)", "115g PEITO DE FRANGO (GRELHADO, COZIDO OU DESFIADO)"]
    ]
  },
  dairy: {
    title: "DERIVADOS",
    show_if: -> { all_foods.any? { |f| f.match?(/requeijÃ£o|queijo|ricota|muÃ§arela|prato|cottage|iogurte|creme/) } },
    items: [
      ["30g REQUEIJÃƒO CREMOSO", "29g QUEIJO MINAS FRESCAL", "86g QUEIJO TIPO COTTAGE"],
      ["56g CREME DE RICOTA", "23g QUEIJO MUÃ‡ARELA", "60g IOGURTE GREGO DESNATADO"],
      ["23g QUEIJO COALHO", "22g QUEIJO PRATO", "15g PASTA DE AMENDOIM"]
    ]
  },
  fruits: {
    title: "FRUTAS",
    show_if: -> { all_foods.any? { |f| f.match?(/banana|abacaxi|ameixa|caju|caqui|goiaba|kiwi|laranja|maÃ§Ã£|mamÃ£o|manga|melancia|melÃ£o|morango|tangerina|pera|pÃªssego|uva|maracujÃ¡|amora|jabuticaba/) } },
    items: [
      ["60g BANANA (PRATA, MAÃ‡Ãƒ OU NANICA)", "118g KIWI", "83g MANGA", "114g UVA RUBI / ITÃLIA"],
      ["125g ABACAXI", "164g LARANJA PERA", "185g MELANCIA", "90g MARACUJÃ"],
      ["115g AMEIXA CRUA", "96g MAÃ‡Ãƒ ARGENTINA", "205g MELÃƒO", "100g AMORA"],
      ["140g CAJU CRU", "109g MAÃ‡Ãƒ FUJI", "200g MORANGO", "150g TANGERINA"],
      ["84g CAQUI", "133g MAMÃƒO FORMOSA", "113g PERA WILLIANS", "100g JABUTICABA"],
      ["111g GOIABA", "150g MAMÃƒO PAPAIA", "166g PÃŠSSEGO", "CASO QUEIRA ALGUMA EM ESPECÃFICO: 50 PEDIR"]
    ]
  }
}

# Verificar quais tabelas devem ser mostradas
tables_to_show = substitution_tables.select { |key, table| table[:show_if].call }
%>

<% if tables_to_show.any? %>
  <div class="page-break"></div>
  
  <div class="substitutions-section">
    <div class="substitutions-header">
      <h2>LISTA DE SUBSTITUIÃ‡Ã•ES (PORÃ‡Ã•ES)</h2>
      <p>CADA PESO EQUIVALE A 1 PORÃ‡ÃƒO</p>
    </div>
    
    <% if all_foods.any? { |f| f.match?(/alimentos jÃ¡ preparados|preparados/) } %>
      <div class="warning-box">
        <strong>âš ï¸ PESAR OS ALIMENTOS JÃ PREPARADOS</strong>
      </div>
    <% end %>
    
    <% tables_to_show.each do |key, table| %>
      <div class="substitution-table">
        <h3 class="table-title"><%= table[:title] %></h3>
        <table>
          <tbody>
            <% table[:items].each do |row| %>
              <tr>
                <% row.each do |item| %>
                  <td><%= item %></td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
<% end %>

<div class="footer">
  <div class="nutritionist-info">
    <div class="nutritionist-details">
      <h4>ğŸ‘¨â€âš•ï¸ Nutricionista ResponsÃ¡vel</h4>
      <p><strong><%= current_user.name %></strong></p>
      <p><%= current_user.specialty %></p>
      <p><strong>CRN:</strong> <%= current_user.license_number %></p>
    </div>
    <div class="contact-info">
      <h4>ğŸ“± Contato</h4>
      <p><strong>Telefone:</strong> <%= current_user.phone %></p>
      <p><strong>Email:</strong> <%= current_user.email %></p>
    </div>
  </div>
  
  <div class="disclaimer">
    <p><strong>âš ï¸ Importante:</strong> Esta prescriÃ§Ã£o nutricional foi elaborada especificamente para <strong><%= @client.name %></strong>. NÃ£o compartilhe com outras pessoas. Em caso de reaÃ§Ãµes adversas ou dÃºvidas, interrompa o uso e entre em contato imediatamente.</p>
  </div>
  
  <div class="signature-area">
    <div class="signature-line">
      <p>_________________________________</p>
      <p><strong><%= current_user.name %></strong></p>
      <p>CRN: <%= current_user.license_number %></p>
    </div>
    <div class="date-line">
      <p>Data: <%= Date.current.strftime('%d/%m/%Y') %></p>
    </div>
  </div>
</div>