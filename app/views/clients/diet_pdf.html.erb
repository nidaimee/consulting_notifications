<!-- app/views/clients/diet_pdf.html.erb -->
<div class="header">
  <h1>üìã Prescri√ß√£o Nutricional</h1>
  <p>Plano Alimentar Personalizado</p>
</div>

<div class="client-info">
  <div class="client-details">
    <h2><%= @client.name %></h2>
    <div class="info-grid">
      <div class="info-item">
        <strong>üìû Telefone:</strong> <%= @client.phone_number %>
      </div>
      <div class="info-item">
        <strong>üìÖ Per√≠odo:</strong> <%= @client.start_date.strftime('%d/%m/%Y') %> at√© <%= @client.end_date.strftime('%d/%m/%Y') %>
      </div>
      <div class="info-item">
        <strong>üìã Data da Prescri√ß√£o:</strong> <%= Date.current.strftime('%d/%m/%Y') %>
      </div>
    </div>
  <% if @client.note.present? %>
  <div class="client-notes">
    <strong>üìù Orienta√ß√µes:</strong>
    <ul>
      <% @client.note.split("\n").each do |linha| %>
        <li style="list-style-type: none;"><%= linha.strip %></li>
      <% end %>
    </ul>
  </div>
<% end %>
  </div>
</div>

<% 
# Mapeamento de meal_types e nomes customizados
meal_type_mapping = {
  'breakfast' => { name: 'Caf√© da Manh√£', time: '8:00', icon: 'üåÖ' },
  'morning_snack' => { name: 'Lanche da Manh√£', time: '10:00', icon: 'üçé' },
  'lunch' => { name: 'Almo√ßo', time: '12:00', icon: 'üçΩÔ∏è' },
  'afternoon_snack' => { name: 'Lanche da Tarde', time: '15:00', icon: 'ü•§' },
  'dinner' => { name: 'Jantar', time: '19:00', icon: 'üåô' },
  'supper' => { name: 'Ceia', time: '22:00', icon: 'üåú' }
}

# Filtrar dietas que t√™m alimentos
diets_with_foods = @diets.select { |d| d.diet_foods.any? }
%>

<div class="meals-container">
  <% if diets_with_foods.any? %>
    <% diets_with_foods.each_with_index do |diet, index| %>
      <% 
      # Determinar nome e √≠cone da refei√ß√£o
      if diet.meal_type.present? && meal_type_mapping[diet.meal_type]
        meal_info = meal_type_mapping[diet.meal_type]
        meal_name = meal_info[:name]
        meal_time = meal_info[:time]
        meal_icon = meal_info[:icon]
      else
        # Se n√£o tiver meal_type ou for customizado, usar o nome da dieta
        meal_name = diet.name
        meal_time = ''
        meal_icon = 'üç¥'
      end
      %>
      
      <div class="meal-section">
        <div class="meal-header">
          <div class="meal-title">
            <span class="meal-icon"><%= meal_icon %></span>
            <span class="meal-name"><%= meal_name %></span>
          </div>
          <% if meal_time.present? %>
            <div class="meal-time"><%= meal_time %></div>
          <% end %>
        </div>
        
        <div class="meal-content">
          <div class="food-list">
            <% diet.diet_foods.includes(:food).each do |diet_food| %>
              <div class="food-item">
                <span class="quantity"><%= diet_food.quantity_grams.to_i %>g</span>
                <span class="food-name"><%= diet_food.food.name %></span>
              </div>
            <% end %>
          </div>
          
          <% if diet.notes.present? %>
            <div class="meal-notes">
              <strong>üí° Observa√ß√£o:</strong> <em><%= diet.notes %></em>
            </div>
          <% end %>
        </div>
      </div>
      
      <% # Page break ap√≥s 3 refei√ß√µes %>
      <% if index == 2 && diets_with_foods.length > 7 %>
        <div class="page-break"></div>
      <% end %>
    <% end %>
  <% else %>
    <div class="no-meals">
      <div class="empty-state">
        <h3>üìù Plano Alimentar em Elabora√ß√£o</h3>
        <p>As refei√ß√µes espec√≠ficas est√£o sendo personalizadas para suas necessidades.</p>
        <p>Entre em contato com seu nutricionista para mais orienta√ß√µes.</p>
      </div>
    </div>
  <% end %>
</div>

<!-- SE√á√ÉO DE SUBSTITUI√á√ïES -->
<%
# Coletar todas as substitui√ß√µes cadastradas manualmente com informa√ß√£o da refei√ß√£o
all_manual_substitutions = {}
has_manual_substitutions = false

@diets.each do |diet|
  # Determinar nome da refei√ß√£o
  meal_name = if diet.meal_type.present? && meal_type_mapping[diet.meal_type]
                meal_type_mapping[diet.meal_type][:name]
              else
                diet.name
              end
  
  diet.diet_foods.includes(:food_substitutions => :substitute_food).each do |diet_food|
    if diet_food.food_substitutions.any?
      has_manual_substitutions = true
      all_manual_substitutions[diet_food.id] = {
        food: diet_food.food,
        quantity: diet_food.quantity_grams,
        substitutions: diet_food.food_substitutions,
        meal_name: meal_name
      }
    end
  end
end
%>

<!-- Sempre adicionar quebra de p√°gina antes das substitui√ß√µes -->
<div class="page-break"></div>

<div class="substitutions-section">
  <div class="substitutions-header">
    <h2 style="margin-bottom: 0;">TABELA DE SUBSTITUI√á√ïES</h2>
    <p style="color: #555; margin-top: 2px;">Op√ß√µes equivalentes para cada alimento</p>
  </div>

  <% if has_manual_substitutions %>
    <div class="custom-substitutions" style="background: #f8fafc; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
      <% substitutions_by_meal = all_manual_substitutions.group_by { |_, data| data[:meal_name] } %>
      
      <% substitutions_by_meal.each do |meal_name, meal_substitutions| %>
        <div class="meal-substitution-group" style="margin-bottom: 18px;">
          <div class="meal-sub-header" style="padding: 6px 0 2px 0; border-bottom: 1px solid #cdd1d2;">
            <h4 style="font-size: 1rem; color: #2d6fa1; letter-spacing: 1px; margin: 0;">
              <span style="font-weight: 600;"><%= meal_name.upcase %></span>
            </h4>
          </div>
          <% meal_substitutions.each do |diet_food_id, data| %>
            <div class="sub-row" style="display: flex; align-items: center; margin: 12px 0;">
              <span class="sub-original" style="flex-shrink: 0; font-weight: 500; color: #333;">
                <%= data[:food].name %>
                <span class="sub-qty-badge" style="background: #e5eef7; color: #205080; border-radius: 6px; padding: 2px 8px; font-size: 0.95em; margin-left: 6px;">
                  <%= data[:quantity].to_i %>g
                </span>
              </span>
              <span class="sub-arrow" style="margin: 0 12px; font-size: 1.1em;">&#8594;</span>
              <span class="sub-options" style="display: flex; flex-wrap: wrap; gap: 8px;">
                <% data[:substitutions].each_with_index do |sub, idx| %>
                  <span style="background: #f2e7fa; color: #7d3ea6; border-radius: 6px; padding: 2px 8px; font-size: 0.95em;">
                    <%= sub.quantity_grams.to_i %>g <%= sub.substitute_food.name %>
                  </span>
                  <% if idx < data[:substitutions].count - 1 %>
                    <span style="color: #888; margin: 0 4px;">ou</span>
                  <% end %>
                <% end %>
              </span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="section-divider" style="height: 2px; background: #e0e5ea; margin: 24px 0;"></div>
  <% end %>
  
  <% # TABELAS FIXAS DE SUBSTITUI√á√ïES %>
  <div class="standard-substitutions">
   
    
    <!-- VEGETAIS A (LIVRES) -->
    <div class="substitution-table">
      <h4 class="table-title">ü•¨ VEGETAIS A (CONSUMO LIVRE)</h4>
      <table>
        <tbody>
          <tr>
            <td>ACELGA</td>
            <td>ABOBRINHA</td>
            <td>BR√ìCOLIS</td>
            <td>ESPINAFRE</td>
            <td>REPOLHO</td>
            <td>ALFACE</td>
            <td>COGUMELOS</td>
            <td>PEPINO</td>
          </tr>
          <tr>
            <td>AGRI√ÉO</td>
            <td>JIL√ì</td>
            <td>CEBOLA</td>
            <td>MOSTARDA</td>
            <td>R√öCULA</td>
            <td>ASPARGO</td>
            <td>COUVE</td>
            <td>RABANETE</td>
          </tr>
          <tr>
            <td>ALCACHOFRA</td>
            <td>AIPO</td>
            <td>CHIC√ìRIA</td>
            <td>PALMITO</td>
            <td>TOMATE</td>
            <td>BERINJELA</td>
            <td>COUVE-FLOR</td>
            <td>PIMENT√ÉO</td>
          </tr>
        </tbody>
      </table>
      
    </div>
    
    <!-- VEGETAIS B -->
    <div class="substitution-table">
      <h4 class="table-title">ü•¨ VEGETAIS B</h4>
      <table>
        <tbody>
          <tr>
            <td>AB√ìBORA</td>
            <td>BETERRABA</td>
            <td>CENOURA</td>
            <td>CHUCHU</td>
          </tr>
          <tr>
            <td>NABO</td>
            <td>QUIABO</td>
            <td>VAGEM</td>
            <td>ERVILHA</td>
          </tr>
          <tr>
            <td>SHIMEJI</td>
            <td>SHITAKE</td>
            <td>MILHO VERDE</td>
            <td>AB√ìBORA CABOTI√Å</td>
          </tr>
        </tbody>
      </table>
     
    </div>
    
    <%
    all_foods = []
    @diets.each do |diet|
      diet.diet_foods.includes(:food).each do |diet_food|
        all_foods << diet_food.food.name.downcase
      end
    end
    all_foods = all_foods.uniq
    %>
     
    
    
  </div>
  
  
</div>

<div class="footer">
  
  
  <div class="signature-area">
    <div class="signature-line">
      <p>_________________________________</p>
      <p><strong><%= current_user.name %></strong></p>
      <p>CRN: <%= current_user.license_number %></p>
    </div>
    <div class="date-line">
      <p>Data: <%= Date.current.strftime('%d/%m/%Y') %></p>
    </div>
  </div>
</div>