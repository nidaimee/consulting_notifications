<!-- app/views/clients/index.html.erb -->

<div class="container-fluid">
  <!-- HEADER -->
  <div class="row mb-4">
    <div class="col-md-6">
      <h1 class="display-6">Meus Clientes</h1>
      <p class="text-muted">
        <i class="bi bi-people"></i> 
        Total: <%= @clients.count %> cliente(s)
      </p>
    </div>
    <div class="col-md-6 text-md-end">
      <%= link_to "Novo Cliente", new_client_path, class: "btn btn-success btn-lg" %>
    </div>
  </div>

  <!-- BARRA DE BUSCA E FILTROS -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <%= form_with url: clients_path, method: :get, local: true, class: "search-form" do |f| %>
        <div class="row g-3">
          <!-- Campo de Busca Principal -->
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text bg-primary text-white">
                <i class="bi bi-search"></i>
              </span>
              <%= text_field_tag :search, 
                                 params[:search], 
                                 placeholder: "Buscar por nome, email ou telefone...",
                                 class: "form-control",
                                 autocomplete: "off" %>
            </div>
          </div>

          <!-- Filtro por Status -->
          <div class="col-md-2">
            <%= select_tag :status,
                          options_for_select([
                            ['Todos os Status', ''],
                            ['Ativos', 'active'],
                            ['Inativos', 'inactive'],
                            ['Pendentes', 'pending']
                          ], params[:status]),
                          class: "form-select" %>
          </div>

          <!-- Filtro por Período -->
          <div class="col-md-2">
            <%= select_tag :period,
                          options_for_select([
                            ['Todos os Períodos', ''],
                            ['Este Mês', 'this_month'],
                            ['Últimos 3 Meses', 'last_3_months'],
                            ['Este Ano', 'this_year']
                          ], params[:period]),
                          class: "form-select" %>
          </div>

          <!-- Ordenação -->
          <div class="col-md-2">
            <%= select_tag :sort_by,
                          options_for_select([
                            ['Ordenar por Nome', 'name'],
                            ['Mais Recentes', 'created_at_desc'],
                            ['Mais Antigos', 'created_at_asc'],
                            ['Valor (Maior)', 'value_desc'],
                            ['Valor (Menor)', 'value_asc']
                          ], params[:sort_by]),
                          class: "form-select" %>
          </div>

          <!-- Botões de Ação -->
          <div class="col-md-2">
            <div class="btn-group w-100">
              <%= submit_tag "Buscar", class: "btn btn-primary" %>
              <%= link_to "Limpar", clients_path, class: "btn btn-outline-secondary" %>
            </div>
          </div>
        </div>

        <!-- Filtros Avançados (Expansível) -->
       
      <% end %>

      <!-- Botão para Mostrar/Ocultar Filtros Avançados -->

    </div>
  </div>

  <!-- RESULTADOS DA BUSCA -->
  <% if params[:search].present? || params.slice(:status, :period, :min_paid_amount, :max_paid_amount).values.any?(&:present?) %>
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      <i class="bi bi-info-circle"></i>
      <strong>Resultados da busca:</strong> 
      Encontrados <%= @clients.count %> cliente(s)
      <% if params[:search].present? %>
        para "<strong><%= params[:search] %></strong>"
      <% end %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <!-- LISTA DE CLIENTES -->
  <div class="row">
    <% if @clients.any? %>
      <% @clients.each do |client| %>
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="card h-100 shadow-sm client-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">
                  <%= client.name %>
                </h5>
                <span class="badge bg-<%= client_status_color(client.status) %>">
                  <%= client.status&.capitalize || 'Active' %>
                </span>
              </div>

              <div class="client-info">
                <p class="mb-1">
                  <i class="bi bi-envelope text-muted"></i> 
                  <small><%= client.email || 'Sem email' %></small>
                </p>
                <p class="mb-1">
                  <i class="bi bi-telephone text-muted"></i> 
                  <small><%= client.phone_number || '(11) 98888-8888' %></small>
                </p>
                <p class="mb-1">
                  <i class="bi bi-calendar text-muted"></i> 
                  <small>
                    Período: <%= client.start_date&.strftime('%d/%m/%Y') || '09/09/2025' %> 
                    a <%= client.end_date&.strftime('%d/%m/%Y') || '08/11/2025' %>
                  </small>
                </p>
                <p class="mb-1">
                  <i class="bi bi-box-seam text-muted"></i>
                  <small>
                    Plano: <%= client.plan_type.present? ? client.plan_type.capitalize : 'Não informado' %>
                  </small>
                </p>
                <p class="mb-3">
                  <i class="bi bi-cash-stack text-muted"></i> 
                  <strong class="text-success">
                  <td>
                  <% if client.paid_amount.present? %>
                    R$ <%= number_with_precision(client.paid_amount, precision: 2, delimiter: '.', separator: ',') %>
                  <% else %>
                    –
                  <% end %>
                </td>
                  </strong>
                </p>
              </div>

              <div class="d-flex gap-2">
                  <%= link_to "Ver Dieta", client_diets_path(client), 
                              class: "btn btn-primary btn-sm flex-fill" %>
                <%= link_to "Editar", edit_client_path(client), 
                            class: "btn btn-warning btn-sm flex-fill" %>
                <%= button_to "Excluir", client_path(client), 
                            data: { 
                              turbo_method: :delete,
                              turbo_confirm: "Tem certeza que deseja excluir #{client.name}?"
                            },
                            class: "btn btn-danger btn-sm flex-fill" %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="col-12">
        <div class="alert alert-warning text-center">
          <i class="bi bi-exclamation-triangle fs-1"></i>
          <h4 class="mt-3">Nenhum cliente encontrado</h4>
          <p>
            <% if params[:search].present? %>
              Não foram encontrados clientes para sua busca.
            <% else %>
              Você ainda não tem clientes cadastrados.
            <% end %>
          </p>
          <div class="mt-3">
            <% if params[:search].present? %>
              <%= link_to "Limpar Busca", clients_path, class: "btn btn-secondary" %>
            <% end %>
            <%= link_to "Adicionar Novo Cliente", new_client_path, class: "btn btn-success" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- PAGINAÇÃO -->
  <% if @clients.respond_to?(:total_pages) %>
    <div class="d-flex justify-content-center mt-4">
      <%= paginate @clients, theme: 'bootstrap-5' %>
    </div>
  <% end %>
</div>

<!-- STYLES -->
<style>
  .client-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: none;
  }
  
  .client-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }
  
  .client-info {
    font-size: 0.9rem;
  }
  
  .search-form .form-control:focus,
  .search-form .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
  }

  .form-check-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }
</style>

<!-- JAVASCRIPT -->
<script>
  // Toggle do texto do botão de filtros avançados
  document.addEventListener('DOMContentLoaded', function() {
    const collapseElement = document.getElementById('advancedFilters');
    const toggleText = document.querySelector('.toggle-text');
    
    if (collapseElement) {
      collapseElement.addEventListener('show.bs.collapse', function () {
        toggleText.textContent = 'Ocultar Filtros Avançados';
      });
      
      collapseElement.addEventListener('hide.bs.collapse', function () {
        toggleText.textContent = 'Mostrar Filtros Avançados';
      });
    }
  });
</script>