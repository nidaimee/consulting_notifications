<!-- app/views/diets/show.html.erb -->
<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <!-- Cabe√ßalho -->
        <div class="card-header bg-primary text-white">
          <h3><%= @diet.name %></h3>
          <p class="mb-0">Cliente: <%= @client.name %></p>
        </div>

        <div class="card-body">
          <!-- Se√ß√£o de Observa√ß√µes com formul√°rio de edi√ß√£o -->
          <div class="card mb-3 border-info">
            <div class="card-header bg-info text-white">
              <h6 class="mb-0">üìù Observa√ß√µes da Refei√ß√£o</h6>
            </div>
            <div class="card-body">
              <%= form_with model: [@client, @diet], url: client_diet_path(@client, @diet), method: :patch, local: true, class: "notes-form" do |form| %>
                <div class="mb-2">
                  <%= form.text_area :notes, 
                                     rows: 3, 
                                     class: "form-control", 
                                     placeholder: "Adicione observa√ß√µes sobre esta refei√ß√£o (hor√°rio, modo de preparo, recomenda√ß√µes...)",
                                     value: @diet.notes %>
                </div>
                <div class="d-flex justify-content-end">
                  <%= form.submit "Adicionar Observa√ß√µes", class: "btn btn-info btn-sm" %>
                </div>
              <% end %>
              
              
            </div>
          </div>

          <!-- Tabela principal com alimentos + substitui√ß√µes -->
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead class="table-dark">
                <tr>
                  <th width="10%">Quantidade</th>
                  <th width="30%">Alimento</th>
                  <th width="12%">Prote√≠na (g)</th>
                  <th width="12%">Carbs (g)</th>
                  <th width="12%">Gordura (g)</th>
                  <th width="12%">Calorias</th>
                  <th width="12%">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <% if @diet.diet_foods.any? %>
                  <% @diet.diet_foods.includes(:food, :food_substitutions).each do |diet_food| %>
                    <!-- Alimento principal -->
                    <tr>
                      <td><strong class="text-primary"><%= diet_food.quantity_grams.to_i %>g</strong></td>
                      <td>
                        <strong><%= diet_food.food.name %></strong>
                        <% if diet_food.food_substitutions.any? %>
                          <span class="badge bg-info ms-2">
                            <%= diet_food.food_substitutions.count %> substitui√ß√£o(√µes)
                          </span>
                        <% end %>
                      </td>
                      <td class="text-primary"><%= diet_food.protein.round(1) %></td>
                      <td class="text-info"><%= diet_food.carbs.round(1) %></td>
                      <td class="text-danger"><%= diet_food.fat.round(1) %></td>
                      <td class="text-warning"><strong><%= diet_food.calories.round(1) %></strong></td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <!-- Bot√£o para adicionar substitui√ß√£o -->
                          <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#substitutionModal<%= diet_food.id %>">+</button>
                          <!-- Bot√£o para remover -->
                          <%= button_to "X", client_diet_diet_food_path(@client, @diet, diet_food),
                                        method: :delete,
                                        data: { confirm: "Tem certeza? Esta a√ß√£o n√£o pode ser desfeita." },
                                        class: "btn btn-danger btn-sm" %>
                        </div>
                      </td>
                    </tr>

                    <!-- Substitui√ß√µes -->
                    <% diet_food.food_substitutions.includes(:substitute_food).each do |substitution| %>
                      <tr class="table-light">
                        <td><span class="text-muted"><%= substitution.quantity_grams.to_i %>g</span></td>
                        <td class="ps-4">
                          <em class="text-muted">‚Ü™ <%= substitution.substitute_food.name %></em>
                          <small class="text-success d-block">SUBSTITUI√á√ÉO</small>
                        </td>
                        <td class="text-muted"><%= substitution.calculated_protein.round(1) %></td>
                        <td class="text-muted"><%= substitution.calculated_carbs.round(1) %></td>
                        <td class="text-muted"><%= substitution.calculated_fat.round(1) %></td>
                        <td class="text-muted"><%= substitution.calculated_calories.round(1) %></td>
                        <td>
                          <%= button_to "Remover", remove_substitution_client_diet_path(@client, @diet, substitution_id: substitution.id),
                                        method: :delete,
                                        data: { turbo_confirm: "Tem certeza?" },
                                        class: "btn btn-sm btn-danger" %>
                        </td>
                      </tr>
                    <% end %>
                  <% end %>
                <% else %>
                  <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                      Nenhum alimento adicionado ainda. Use o formul√°rio abaixo para come√ßar!
                    </td>
                  </tr>
                <% end %>
              </tbody>
              <tfoot class="table-success">
                <tr class="fw-bold">
                  <td>TOTAL</td>
                  <td>-</td>
                  <td class="text-primary"><%= @diet.total_protein.round(1) %>g</td>
                  <td class="text-info"><%= @diet.total_carbs.round(1) %>g</td>
                  <td class="text-danger"><%= @diet.total_fat.round(1) %>g</td>
                  <td class="text-warning fs-5"><%= @diet.total_calories.round(1) %> kcal</td>
                  <td>-</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Formul√°rio para adicionar novo alimento -->
          <div class="card mt-4">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">‚ûï Adicionar Alimento Principal</h5>
            </div>
            <div class="card-body">
              <%= form_with url: add_food_client_diet_path(@client, @diet), method: :post, local: true do |form| %>
                <div class="row align-items-end">
                  <div class="col-md-4">
                    <%= form.label :food_id, "Alimento", class: "form-label" %>
                    <%= form.select :food_id, options_from_collection_for_select(@available_foods, :id, :name),
                                    { prompt: "Selecione um alimento..." },
                                    { class: "form-select", id: "food_select_main" } %>
                  </div>
                  <div class="col-md-3">
                    <%= form.label :quantity_grams, "Quantidade (gramas)", class: "form-label" %>
                    <%= form.number_field :quantity_grams, min: 1, step: 1,
                                          class: "form-control", placeholder: "Ex: 150",
                                          id: "quantity_input_main" %>
                  </div>
                  <div class="col-md-3">
                    <div id="nutrition_preview_main" class="alert alert-info py-2" style="display: none;">
                      <small><strong>Pr√©via:</strong><br>
                      <span id="calculated_values_main"></span></small>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <%= form.submit "Adicionar", class: "btn btn-success w-100" %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- A√ß√µes -->
          <div class="mt-4 d-flex gap-2">
            <%= link_to "Voltar", client_diets_path(@client), class: "btn btn-secondary" %>
            <%= link_to "Editar", edit_client_diet_path(@client, @diet), class: "btn btn-warning" %>
            <%= button_to "Excluir", client_diet_path(@client, @diet),
                          method: :delete,
                          data: { turbo_confirm: "Tem certeza? Esta a√ß√£o n√£o pode ser desfeita." },
                          class: "btn btn-danger" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modais para substitui√ß√µes -->
<% @diet.diet_foods.each do |diet_food| %>
  <div class="modal fade" id="substitutionModal<%= diet_food.id %>" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Adicionar Substitui√ß√£o para <%= diet_food.food.name %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <%= form_with url: add_substitution_client_diet_path(@client, @diet), method: :post, local: true do |form| %>
          <div class="modal-body">
            <%= form.hidden_field :diet_food_id, value: diet_food.id %>
            <div class="mb-3">
              <label class="form-label">Alimento Substituto</label>
              <%= form.select :substitute_food_id, options_from_collection_for_select(@available_foods, :id, :name),
                              { prompt: "Selecione um alimento..." },
                              { class: "form-select" } %>
            </div>
            <div class="mb-3">
              <label class="form-label">Quantidade (gramas)</label>
              <%= form.number_field :quantity_grams, min: 1, step: 1, class: "form-control", placeholder: "Ex: 100" %>
              <div class="form-text">
                Quantidade equivalente para substituir <%= diet_food.quantity_grams.to_i %>g de <%= diet_food.food.name %>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Observa√ß√µes (opcional)</label>
              <%= form.text_area :notes, rows: 2, class: "form-control", placeholder: "Ex: Preferir integral, pode ser usado no jantar..." %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <%= form.submit "Adicionar Substitui√ß√£o", class: "btn btn-success" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Script para c√°lculo nutricional em tempo real e auto-save das observa√ß√µes -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // C√≥digo existente para c√°lculo nutricional
  const foodSelectMain = document.getElementById('food_select_main');
  const quantityInputMain = document.getElementById('quantity_input_main');
  const nutritionPreviewMain = document.getElementById('nutrition_preview_main');
  const calculatedValuesMain = document.getElementById('calculated_values_main');

  const foodsData = {
    <% @available_foods.each do |food| %>
      <%= food.id %>: {
        name: "<%= food.name %>",
        calories: <%= food.calories_per_100g %>,
        protein: <%= food.protein_per_100g %>,
        carbs: <%= food.carbs_per_100g %>,
        fat: <%= food.fat_per_100g %>
      },
    <% end %>
  };

  function calculateNutritionMain() {
    const foodId = foodSelectMain.value;
    const quantity = parseFloat(quantityInputMain.value);

    if (!foodId || !quantity || quantity <= 0) {
      nutritionPreviewMain.style.display = 'none';
      return;
    }

    const food = foodsData[foodId];
    if (!food) {
      nutritionPreviewMain.style.display = 'none';
      return;
    }

    const calories = (quantity * food.calories / 100).toFixed(1);
    const protein = (quantity * food.protein / 100).toFixed(1);
    const carbs = (quantity * food.carbs / 100).toFixed(1);
    const fat = (quantity * food.fat / 100).toFixed(1);

    calculatedValuesMain.innerHTML = `
      <span class="text-warning">${calories} kcal</span> |
      <span class="text-primary">P: ${protein}g</span> |
      <span class="text-info">C: ${carbs}g</span> |
      <span class="text-danger">G: ${fat}g</span>
    `;

    nutritionPreviewMain.style.display = 'block';
  }

  if (foodSelectMain) foodSelectMain.addEventListener('change', calculateNutritionMain);
  if (quantityInputMain) quantityInputMain.addEventListener('input', calculateNutritionMain);

  // Auto-save para as observa√ß√µes (opcional)
  const notesForm = document.querySelector('.notes-form');
  const notesTextarea = notesForm ? notesForm.querySelector('textarea[name="diet[notes]"]') : null;
  let saveTimeout;

  if (notesTextarea) {
    notesTextarea.addEventListener('input', function() {
      clearTimeout(saveTimeout);
      // Adiciona um indicador visual de que est√° salvando
      notesTextarea.style.borderColor = '#ffc107';
      
      saveTimeout = setTimeout(function() {
        // Submete o formul√°rio automaticamente ap√≥s 2 segundos de inatividade
        const submitButton = notesForm.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.value = 'Salvando...';
          submitButton.disabled = true;
        }
        
        // Simula o envio do formul√°rio via AJAX (Rails UJS)
        fetch(notesForm.action, {
          method: 'PATCH',
          body: new FormData(notesForm),
          headers: {
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
            'Accept': 'text/html'
          }
        }).then(response => {
          if (response.ok) {
            notesTextarea.style.borderColor = '#28a745';
            if (submitButton) {
              submitButton.value = 'Observa√ß√µes Salvas ‚úì';
              setTimeout(() => {
                submitButton.value = 'Salvar Observa√ß√µes';
                submitButton.disabled = false;
                notesTextarea.style.borderColor = '';
              }, 2000);
            }
          }
        }).catch(error => {
          notesTextarea.style.borderColor = '#dc3545';
          if (submitButton) {
            submitButton.value = 'Erro ao salvar';
            submitButton.disabled = false;
          }
        });
      }, 2000);
    });
  }
});
</script>