#!/usr/bin/env bash
set -e

echo "[entrypoint] Iniciando container Rails (env=$RAILS_ENV)"

echo "[entrypoint] Debug vars (parcial):"
env | grep -E 'DATABASE_URL|PGHOST|PGUSER|PGDATABASE|RENDER|RAILS_ENV' || true

bundle check || bundle install

if [ "$RAILS_ENV" = "production" ]; then
  if [ -z "$DATABASE_URL" ]; then
    echo "[entrypoint][ERRO] DATABASE_URL não está definida!"
    echo "Verifique em: Render > Web Service > Environment se ela existe."
    exit 1
  fi
fi

echo "[entrypoint] Verificando disponibilidade do banco..."
for i in {1..30}; do
  if bundle exec rails db:version >/dev/null 2>&1; then
    echo "[entrypoint] Banco acessível."
    break
  fi
  echo "[entrypoint] Tentativa $i: banco indisponível, aguardando..."
  sleep 2
done

echo "[entrypoint] Rodando migrations..."
bundle exec rails db:migrate 2>/dev/null || bundle exec rails db:setup

echo "[entrypoint] Iniciando aplicação..."
exec "$@"